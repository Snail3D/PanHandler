# V2.2.4 - Smart Recalibrate Button Logic

**Status**: ✅ COMPLETE  
**Date**: October 17, 2025

## Problem
The Recalibrate button always went back to the coin calibration screen, regardless of what calibration method was used. This was inconvenient for users who:
- Only set map scale (no coin)
- Wanted to adjust map scale without redoing coin calibration

## Solution

### New Recalibrate Button Behavior

The Recalibrate button now intelligently detects what calibration method(s) were used and responds accordingly:

#### Scenario 1: Map Scale ONLY (No Coin/Blueprint/Verbal)
**User workflow:**
1. Skip coin calibration (tap "Map" button)
2. Set map scale (verbal or blueprint)
3. Tap "Recalibrate"

**Behavior:**
- ✅ Reset map scale
- ✅ Reopen map scale modal
- ✅ Stay in measurement screen
- ❌ Does NOT go back to coin screen

**Why:** User only wants to adjust map scale, no need to redo coin calibration they never did.

#### Scenario 2: Coin/Blueprint/Verbal ONLY (No Map Scale)
**User workflow:**
1. Complete coin calibration (or blueprint/verbal)
2. Tap "Recalibrate"

**Behavior:**
- ✅ Go back to coin calibration screen
- ✅ Clear calibration
- ✅ Clear measurements

**Why:** This is the original behavior, unchanged.

#### Scenario 3: BOTH Calibration AND Map Scale
**User workflow:**
1. Complete coin calibration
2. Set map scale additionally
3. Tap "Recalibrate"

**Behavior:**
- ✅ Reset BOTH calibrations (coin + map)
- ✅ Go back to coin calibration screen
- ✅ Clear measurements
- ✅ User can recalibrate coin, then set map scale again

**Why:** User wants to start completely over, so reset everything.

## Technical Implementation

### Changes Made

#### 1. **Updated Recalibrate Button Condition** (Line 3010)
```typescript
// Before:
{coinCircle && !showLockedInAnimation && !isCapturing && (

// After:
{(coinCircle || calibration || mapScale) && !showLockedInAnimation && !isCapturing && (
```

**Why:** Button now appears when there's ANY calibration method, not just coin.

#### 2. **Added Smart Logic** (Lines 3012-3034)
```typescript
onPress={() => {
  Haptics.impactAsync(Haptics.ImpactFeedbackStyle.Medium);
  
  // Scenario 1: Map scale ONLY (no coin, no other calibration)
  if (mapScale && !calibration && !coinCircle) {
    setMapScale(null);
    setIsMapMode(false);
    setShowMapScaleModal(true); // Reopen modal
  }
  // Scenario 2: BOTH calibration AND map scale
  else if (mapScale && (calibration || coinCircle)) {
    setMapScale(null);
    setIsMapMode(false);
    if (onReset) onReset(true); // Go to coin screen
  }
  // Scenario 3: Calibration ONLY
  else {
    if (onReset) onReset(true); // Go to coin screen
  }
}}
```

### State Variables Used

- **`mapScale`**: Map scale calibration data (verbal/blueprint)
- **`calibration`**: Coin/blueprint/verbal calibration data
- **`coinCircle`**: Coin circle data (from coin calibration)

### Decision Logic

```
Has mapScale? Has calibration/coin?  →  Action
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    YES            NO               →  Reset map, reopen modal
    YES            YES              →  Reset both, go to coin screen  
    NO             YES              →  Go to coin screen
```

## User Experience Impact

### Before v2.2.4
```
User: Sets map scale only
User: Taps "Recalibrate"
App: Goes to coin screen ❌
User: "Why? I just want to adjust map scale!"
```

### After v2.2.4
```
User: Sets map scale only
User: Taps "Recalibrate"
App: Reopens map scale modal ✅
User: Adjusts scale, locks in
User: "Perfect!"
```

## Files Modified

1. **`/src/components/DimensionOverlay.tsx`**
   - Line 3010: Updated recalibrate button condition
   - Lines 3012-3034: Added smart recalibrate logic

## Testing Checklist

### Test Scenario 1: Map Scale Only
- [ ] Skip coin calibration (tap "Map" button in ZoomCalibration)
- [ ] Go to measurement screen
- [ ] Set map scale (verbal or blueprint)
- [ ] Tap "Recalibrate" button
- [ ] Verify: Map scale modal reopens
- [ ] Verify: Still in measurement screen (did NOT go to coin screen)
- [ ] Verify: mapScale is reset
- [ ] Set new map scale
- [ ] Verify: Works correctly

### Test Scenario 2: Coin Only
- [ ] Complete coin calibration
- [ ] Go to measurement screen
- [ ] Do NOT set map scale
- [ ] Tap "Recalibrate" button
- [ ] Verify: Goes back to coin calibration screen
- [ ] Verify: calibration is cleared
- [ ] Verify: measurements are cleared

### Test Scenario 3: Both Calibrations
- [ ] Complete coin calibration
- [ ] Go to measurement screen
- [ ] Set map scale
- [ ] Make some measurements
- [ ] Tap "Recalibrate" button
- [ ] Verify: Goes back to coin calibration screen
- [ ] Verify: Both calibrations cleared
- [ ] Verify: Measurements cleared
- [ ] Recalibrate coin
- [ ] Go to measurement screen
- [ ] Can set map scale again

### Visual Checks
- [ ] Recalibrate button appears with coin calibration
- [ ] Recalibrate button appears with blueprint calibration
- [ ] Recalibrate button appears with verbal calibration
- [ ] Recalibrate button appears with map scale only
- [ ] Button positioning correct (below calibration badge)
- [ ] Button styling unchanged (red background)

## Edge Cases Handled

1. **Blueprint calibration + map scale**: Resets both, goes to coin screen
2. **Verbal scale calibration + map scale**: Resets both, goes to coin screen
3. **Map scale set multiple times**: Reset still works
4. **No calibration at all**: Button doesn't appear (correct)

## Related Features

- **Map Scale** (v2.2.0): Verbal and blueprint scale calibration
- **Skip to Map** (v2.2.3): New Map button in calibration screen
- **Blueprint Cursor** (v2.2.2): Blueprint uses measurement cursor system

## Known Behavior

- Recalibrate button only appears when there's some calibration
- Button text stays "Recalibrate" for all scenarios (no dynamic text)
- Haptic feedback fires on all recalibrate actions
- Map scale modal opens automatically in Scenario 1

---

**Previous Version**: v2.2.3 (Calibration Menu Redesign)  
**Current Version**: v2.2.4 (Smart Recalibrate Logic)  
**Next Version**: TBD
