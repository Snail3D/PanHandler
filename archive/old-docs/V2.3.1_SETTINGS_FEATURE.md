# V2.3.1 - Settings Feature Release

## Overview
Added comprehensive Settings section to Help modal with three key user preferences:
1. **Email Address Management** - Store and update email for auto-populated reports
2. **Default Measurement System** - Set preferred units (Metric/Imperial) for new sessions
3. **Magnetic Declination** - Adjust for True North vs Magnetic North on maps

---

## What's New

### 1. Settings Section in Help Modal
**Location:** Bottom of Help modal (before Easter Eggs section)

**Features:**
- Clean, Apple-style glassmorphic design
- Three collapsible setting categories
- Instant feedback with haptics

### 2. Email Address Setting
**Purpose:** Store user's email for auto-populating email reports

**Implementation:**
- Shows current email or "Not set"
- Tap to change (placeholder for future modal)
- Email stored locally, never uploaded
- Privacy-focused (mentioned in Privacy section)

**State:** `userEmail` (already existed, now accessible in Settings)

### 3. Default Measurement System
**Purpose:** Set preferred units for ALL new sessions

**How It Works:**
- **Two options:** Metric (mm) or Imperial (in)
- **Active state:** Purple background with white text
- **Inactive state:** Light purple with purple text
- **Behavior:**
  - New photo sessions start with this preference
  - Can still change units mid-session
  - If you leave and return to same session, keeps session's current units

**State Management:**
- `defaultUnitSystem`: User's preference (persisted)
- `unitSystem`: Current session's active units (can differ from default)

**Logic:** When `setImageUri()` is called with a new image, `unitSystem` is set to `defaultUnitSystem`

### 4. Magnetic Declination
**Purpose:** Adjust azimuth/compass measurements for True North vs Magnetic North

**What is Magnetic Declination?**
- The angle between True North (geographic) and Magnetic North (compass)
- Varies by location (0° to 20°+ difference)
- Positive = East declination
- Negative = West declination

**Implementation:**
- Shows current declination (default: 0°)
- Displays "East" or "West" based on sign
- Tap to change (placeholder for input modal)
- Info alert explains concept with NOAA reference

**State:** `magneticDeclination` (persisted, default: 0)

**Future Use:** Will be applied to Azimuth mode calculations in Map Mode

---

## Technical Details

### Files Modified

#### 1. `/src/state/measurementStore.ts`
**Added State:**
```typescript
defaultUnitSystem: UnitSystem; // User's preferred default for NEW sessions
magneticDeclination: number;   // Degrees (+ = East, - = West)
```

**Added Setters:**
```typescript
setDefaultUnitSystem: (system: UnitSystem) => void;
setMagneticDeclination: (degrees: number) => void;
```

**Updated Logic:**
- `setImageUri()` now applies `defaultUnitSystem` to `unitSystem` for new sessions
- Both states persisted in AsyncStorage

**Persistence:**
```typescript
partialize: (state) => ({ 
  unitSystem: state.unitSystem,           // Current session units
  defaultUnitSystem: state.defaultUnitSystem, // User preference
  magneticDeclination: state.magneticDeclination,
  // ... other persisted state
})
```

#### 2. `/src/components/HelpModal.tsx`
**Added Hooks:**
```typescript
const userEmail = useStore((s) => s.userEmail);
const defaultUnitSystem = useStore((s) => s.defaultUnitSystem);
const setDefaultUnitSystem = useStore((s) => s.setDefaultUnitSystem);
const magneticDeclination = useStore((s) => s.magneticDeclination);
const setMagneticDeclination = useStore((s) => s.setMagneticDeclination);
```

**New Section:**
- ~150 lines of Settings UI
- Glassmorphic card design matching existing aesthetic
- Interactive toggle buttons for unit system
- Placeholder modals for email/declination input (future)

---

## User Experience Flow

### Setting Default Units
1. Open Help modal (? icon)
2. Scroll to "Settings" section
3. Tap "Metric (mm)" or "Imperial (in)"
4. Haptic feedback confirms selection
5. Active option shows purple background

### Starting New Session
1. Take new photo → Session starts with `defaultUnitSystem`
2. User can still toggle units mid-session (existing behavior)
3. If user leaves app and returns → Session keeps its current units

### Example Scenario:
```
User preferences:
- defaultUnitSystem: "imperial"

Timeline:
1. User takes Photo A → Units start as "imperial"
2. User changes to "metric" mid-session
3. User leaves app
4. User returns → Photo A session still shows "metric" ✓
5. User takes Photo B → NEW session starts as "imperial" ✓
```

---

## Design Decisions

### Why Separate `defaultUnitSystem` from `unitSystem`?
**Problem:** User wants metric by default, but if they switch to imperial mid-session, that preference should persist for THAT session only.

**Solution:**
- `defaultUnitSystem` = Global preference (what new sessions start with)
- `unitSystem` = Current session's active units (can be changed)

### Why Persist Both?
- `defaultUnitSystem` → User's long-term preference
- `unitSystem` → Resume session with same units if app is closed

### Why Not Auto-Switch Mid-Session?
User might have:
- 5 measurements in metric
- Changed preference to imperial
- Doesn't want existing measurements affected

---

## Future Enhancements

### Email Input Modal
**Needed:**
- TextInput component
- Email validation (regex)
- Save/Cancel buttons
- Keyboard handling

**Trigger:** Tap "Email Address" setting

### Declination Input Modal
**Needed:**
- Numeric input with +/- support
- Validation (-180° to +180°)
- Helper text: "Find at ngdc.noaa.gov"
- Possibly GPS-based auto-detection

**Trigger:** Tap "Magnetic Declination" setting

### Apply Declination to Azimuth
**Current:** Azimuth mode measures raw angle
**Future:** Add `magneticDeclination` offset to reading
- User sets 15° East → Azimuth adds 15° to displayed angle
- Converts Magnetic → True North automatically

---

## Testing Checklist

- [x] Code compiles without errors
- [x] Settings section renders in Help modal
- [x] Metric/Imperial toggle updates state
- [x] State persists across app restarts
- [ ] New sessions start with defaultUnitSystem ⚠️ (needs testing)
- [ ] Mid-session unit changes don't affect default
- [ ] Email displays correctly (if set)
- [ ] Declination displays with correct East/West label
- [ ] Haptics fire on button presses

---

## Known Limitations

1. **Email/Declination input not implemented yet**
   - Placeholders show info alerts
   - Full modals coming in future update

2. **Declination not applied to Azimuth yet**
   - State is stored and ready
   - Azimuth calculation needs update

3. **No GPS-based declination**
   - Manual entry required
   - Could add NOAA API integration later

---

## Version Info

**Version:** 2.3.1  
**Previous:** 2.3.0 (Universal fingerprints)  
**Date:** October 18, 2025  

**Changes:**
- Settings section in Help modal
- Default unit system preference
- Magnetic declination setting
- Improved session management

---

## Code References

### State Management
```typescript
// Get default preference
const defaultUnits = useStore.getState().defaultUnitSystem;

// Get current session units
const currentUnits = useStore.getState().unitSystem;

// Change default preference
useStore.getState().setDefaultUnitSystem('metric');

// Change current session units
useStore.getState().setUnitSystem('imperial');

// Set declination
useStore.getState().setMagneticDeclination(15); // 15° East
```

### New Session Logic
```typescript
// When user takes new photo:
setImageUri(newUri); 
// → Clears measurements
// → Sets unitSystem = defaultUnitSystem
// → User starts with preferred units
```

---

## Summary

This update gives users control over their measurement preferences while maintaining flexibility. The split between `defaultUnitSystem` (global) and `unitSystem` (session) ensures:

1. ✅ New sessions start with user's preferred units
2. ✅ Mid-session changes don't affect the default
3. ✅ Returning to saved sessions preserves session units
4. ✅ Future-ready for magnetic declination in map mode

The Settings section is polished, accessible, and follows Apple's HIG with glassmorphism, haptics, and clear visual feedback.
