# v2.5.0 - Landscape Orientation Detection Fix

## Version
**2.3.2 â†’ 2.5.0**

## Critical Fix

### ðŸŽ¯ Landscape Orientation Detection for Crosshairs and Photo Routing

**User Report**: "When I take a picture in horizontal mode or landscape looking at the wall, the crosshairs are still there and it's going to coin calibration mode instead of the menu."

#### Problem:
1. **Crosshairs showing when looking at wall in landscape**: Colored leveling crosshairs remained visible when pointing at a wall in landscape orientation
2. **Wrong photo routing in landscape**: Photos taken of walls in landscape went to coin calibration instead of showing the photo type menu
3. **Portrait mode worked fine**: The issue only occurred in landscape orientation

#### Root Cause:
The orientation detection only checked `beta` angle (forward/backward tilt), which works for portrait but not landscape. In landscape orientation, the phone axes are rotated 90Â°, so we need to check `gamma` (left/right tilt) as well.

**Original logic**:
```typescript
const nowHorizontal = absBeta < 45; // Only checks beta - fails in landscape!
```

When holding the phone in landscape and pointing at a wall:
- Beta might still be < 45Â° (phone not tilted forward/back much)
- But gamma is > 45Â° (phone is rotated sideways)
- System incorrectly thinks you're looking down at a table

---

## The Fix

### 1. Crosshair Visibility (Lines 606-618)

**Before**:
```typescript
const nowHorizontal = absBeta < 45; // Only checks beta
```

**After**:
```typescript
// Need to handle both portrait and landscape orientations
const absGamma = Math.abs(gamma);

// Looking down at table: small beta (portrait) OR small gamma (landscape)
// Looking at wall: large beta (portrait) OR large gamma (landscape)
const nowHorizontal = absBeta < 45 && absGamma < 45;
```

Now checks **BOTH** axes - phone is only considered "looking down" if both beta AND gamma are small.

### 2. Photo Routing Logic (Lines 1112-1126)

**Before**:
```typescript
const absBeta = Math.abs(currentBeta);
const isLookingAtTable = absBeta < 45; // Only checks beta
```

**After**:
```typescript
// Must check BOTH beta and gamma to handle portrait AND landscape
const absBeta = Math.abs(currentBeta);
const absGamma = Math.abs(currentGamma);
const isLookingAtTable = absBeta < 45 && absGamma < 45; // BOTH axes
```

---

## How Orientation Detection Works

### Understanding Phone Axes

When the phone is in **portrait** (normal vertical holding):
- **Beta**: Forward/backward tilt (pitch)
  - 0Â° = flat on table
  - 90Â° = upright looking at wall
- **Gamma**: Left/right tilt (roll)
  - 0Â° = level
  - Â±90Â° = tilted to side

When the phone is in **landscape** (rotated 90Â° sideways):
- **Beta**: Now measures left/right tilt (what was gamma)
- **Gamma**: Now measures forward/backward tilt (what was beta)
- The axes are effectively swapped!

### Detection Logic

**Looking DOWN at table** (horizontal mode):
- Portrait: `beta < 45Â°` AND `gamma < 45Â°`
- Landscape: `beta < 45Â°` AND `gamma < 45Â°`
- Both axes must be small â†’ Phone is flat/tilted down
- **Result**: Crosshairs visible, auto coin calibration

**Looking AT WALL** (vertical mode):
- Portrait: `beta > 45Â°` (phone upright) â†’ `nowHorizontal = false`
- Landscape: `gamma > 45Â°` (phone rotated) â†’ `nowHorizontal = false`
- At least one axis is large â†’ Phone is upright
- **Result**: Crosshairs hidden, show photo type menu

---

## Complete Photo Flow

### Scenario 1: Taking Photo of Object on Table

1. **User positions phone** looking down at table
2. **Sensors detect**: `beta < 45Â°` AND `gamma < 45Â°`
3. **Crosshairs visible**: Colored leveling crosshairs show to help align
4. **User taps shutter** or auto-capture triggers
5. **Routing decision**: `isLookingAtTable = true`
6. **Result**: Auto-proceed to coin calibration screen âœ…

### Scenario 2: Taking Photo of Wall (Portrait)

1. **User positions phone** upright looking at wall
2. **Sensors detect**: `beta > 45Â°` (upright)
3. **Crosshairs hidden**: No colored leveling crosshairs
4. **User taps shutter**
5. **Routing decision**: `isLookingAtTable = false` (beta large)
6. **Result**: Show photo type selection menu âœ…

### Scenario 3: Taking Photo of Wall (Landscape) - **FIXED!**

1. **User positions phone** sideways (landscape) looking at wall
2. **Sensors detect**: `gamma > 45Â°` (rotated)
3. **Crosshairs hidden**: No colored leveling crosshairs âœ… (was broken)
4. **User taps shutter**
5. **Routing decision**: `isLookingAtTable = false` (gamma large) âœ… (was broken)
6. **Result**: Show photo type selection menu âœ…

---

## What Stays Visible vs What Hides

### Always Visible (Reference):
- âœ… Gray horizontal crosshair (center reference)
- âœ… Gray vertical crosshair (center reference)
- âœ… Center 120px crosshair box (with glow when level)

### Conditional (Only When Looking Down):
- ðŸŽ¨ **Colored floating horizontal line** (moves with tilt)
- ðŸŽ¨ **Colored floating vertical line** (moves with tilt)
- These are the LEVELING indicators that fade out when looking at wall

---

## Technical Details

### Files Modified
- `src/screens/MeasurementScreen.tsx`
  - Line 606-618: Crosshair visibility detection
  - Line 1112-1126: Photo routing detection
- `app.json`
  - Version: 2.3.2 â†’ 2.5.0

### Shared Values Updated
- `isHorizontal.value`: Now checks both beta AND gamma
- `levelLinesOpacity.value`: Fades based on new detection

### Console Logging (Dev Mode)
```typescript
console.log('ðŸ“· Photo captured - Phone tilt:', {
  beta: currentBeta.toFixed(1),
  gamma: currentGamma.toFixed(1),
  absBeta: absBeta.toFixed(1),
  absGamma: absGamma.toFixed(1),
  isLookingAtTable,
  decision: isLookingAtTable ? 'AUTO COIN CALIBRATION (table)' : 'SHOW MENU (wall)'
});
```

---

## Testing Results

### âœ… Portrait - Looking Down at Table
- Crosshairs: Visible
- Routing: Coin calibration
- Status: Working

### âœ… Portrait - Looking at Wall
- Crosshairs: Hidden
- Routing: Photo type menu
- Status: Working

### âœ… Landscape - Looking Down at Table
- Crosshairs: Visible
- Routing: Coin calibration
- Status: Working

### âœ… Landscape - Looking at Wall (FIXED!)
- Crosshairs: Hidden (was showing before)
- Routing: Photo type menu (was going to calibration before)
- Status: **NOW WORKING!**

---

## Why v2.5.0?

This is a significant fix that corrects a major UX issue where landscape orientation was completely broken. The dual-axis detection is fundamental to the app's photo routing logic. Bumped minor version to reflect the importance of this fix.

---

## Status

âœ… **Initial camera screen fully working**
âœ… **Orientation detection working in all modes**
âœ… **Photo routing working correctly**
âœ… **Ready for production**

Further improvements may be needed, but the core camera flow is now solid and should not be reverted.
