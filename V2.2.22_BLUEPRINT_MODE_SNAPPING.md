# v2.2.22 - Blueprint Mode Snapping

## Release Date
October 17, 2025

## Summary
Added horizontal/vertical snapping guides to blueprint mode (map scale two-point placement), matching the exact snapping behavior of the distance measurement tool.

---

## 🎯 Feature Request

### User Description
> "I'd like the point placement for the map scale to have the same snapping logic, the exact same snapping logic for horizontal and vertical lines as placing line points does where it has that nice little guide. You can copy it exactly from the line placing tool."

### What Changed
Blueprint mode now has the same intelligent horizontal/vertical snapping that the distance measurement tool has.

---

## How It Works

### Snapping Behavior
When placing the **second point** in blueprint mode:

1. **Horizontal Snap:** If within 3° of horizontal (0° or 180°), cursor snaps to horizontal alignment
2. **Vertical Snap:** If within 3° of vertical (90° or -90°), cursor snaps to vertical alignment
3. **Visual Guide:** Snap guides appear when aligned (same as distance tool)
4. **Haptic Feedback:** Medium haptic when entering snap, light haptic when leaving snap
5. **Hysteresis:** 3° to enter snap, 4° to exit (prevents jittering on/off)

### Example Use Cases

**Measuring horizontal map scale bar:**
1. Tap first point on left end of scale bar
2. Move cursor right → automatically snaps to horizontal
3. Tap second point → perfectly horizontal line ✅

**Measuring vertical map scale bar:**
1. Tap first point on top of scale bar
2. Move cursor down → automatically snaps to vertical
3. Tap second point → perfectly vertical line ✅

**Measuring diagonal reference:**
1. Tap first point
2. Move cursor at ~45° → no snap (diagonal allowed)
3. Tap second point → preserves angle ✅

---

## User Experience

### Before Fix
❌ No snap guides in blueprint mode  
❌ Hard to place perfectly horizontal/vertical lines  
❌ Inconsistent with distance measurement tool  
❌ Had to eyeball alignment  

### After Fix
✅ Same snapping behavior as distance tool  
✅ Easy to place perfectly aligned lines  
✅ Consistent UX across all two-point placements  
✅ Visual and haptic feedback for alignment  

---

## Technical Details

### Implementation
**File:** `/src/components/DimensionOverlay.tsx`  
**Function:** `snapCursorToAlignment()` (lines 998-1054)

**Changes Made:**
1. Added blueprint mode condition to snap check:
   ```typescript
   const shouldSnap = (mode === 'distance' && currentPoints.length === 1) || 
                      (mode === 'angle' && currentPoints.length === 1) ||
                      (isPlacingBlueprint && blueprintPoints.length === 1); // NEW
   ```

2. Added logic to get first point from either `currentPoints` or `blueprintPoints`:
   ```typescript
   let firstPoint;
   if (isPlacingBlueprint && blueprintPoints.length === 1) {
     firstPoint = imageToScreen(blueprintPoints[0].x, blueprintPoints[0].y);
   } else if (currentPoints.length > 0) {
     firstPoint = imageToScreen(currentPoints[0].x, currentPoints[0].y);
   }
   ```

3. Rest of snapping logic remains identical (angle calculation, thresholds, snap detection)

### Snapping Parameters
- **Entry Threshold:** 3° (must be within 3° to snap)
- **Exit Threshold:** 4° (must be 4° away to break snap)
- **Minimum Distance:** 20px (don't snap if too close to first point)
- **Snap Angles:**
  - Horizontal: 0° or 180° (±3°)
  - Vertical: 90° or -90° (±3°)

### Modes That Use Snapping
1. **Distance measurement** - When placing 2nd point
2. **Angle measurement** - When placing 2nd point (before vertex)
3. **Blueprint mode** - When placing 2nd point (NEW)

---

## Visual Guide

### Horizontal Snap
```
First point: ●
                           
                           [Cursor snaps to horizontal line]
●━━━━━━━━━━━━━━━━━━━━━━━━━━━━○

Second point placement
```

### Vertical Snap
```
First point: ●
             ┃
             ┃  [Cursor snaps to vertical line]
             ┃
             ┃
             ○
             
Second point placement
```

### Diagonal (No Snap)
```
First point: ●
              \
               \  [No snap - diagonal allowed]
                \
                 \
                  ○
                  
Second point placement
```

---

## Testing Checklist

### Blueprint Mode Snapping
- [x] Place 1st point → Move cursor horizontally → Snaps to horizontal ✓
- [x] Place 1st point → Move cursor vertically → Snaps to vertical ✓
- [x] Place 1st point → Move cursor diagonally → No snap (free movement) ✓
- [x] Haptic feedback when entering snap ✓
- [x] Haptic feedback when leaving snap ✓

### No Regressions
- [x] Distance tool still has snapping ✓
- [x] Angle tool still has snapping ✓
- [x] Other modes unaffected ✓

### Edge Cases
- [x] Too close to first point → No snap (< 20px) ✓
- [x] Hysteresis prevents jitter (3° entry, 4° exit) ✓
- [x] Works in both horizontal and vertical orientations ✓

---

## Why This Improves UX

### Use Case: Measuring Map Scale Bar
Many maps have a scale bar that's **perfectly horizontal or vertical**. Before this fix, users had to eyeball the alignment, which could introduce measurement errors.

**Example:**
- Map scale bar: `━━━━━ 1km`
- Without snap: User might place points slightly off-angle
- With snap: Points automatically align perfectly with scale bar
- Result: More accurate calibration!

### Consistency Benefits
- **Mental Model:** "Two-point placement always has snapping"
- **Muscle Memory:** Same behavior in distance tool and blueprint mode
- **Predictability:** Users know what to expect

---

## Version History
- **v2.2.17** - Map scale UX improvement
- **v2.2.18** - Undo single point + feet/inches formatting
- **v2.2.19** - Fixed polygon auto-detection
- **v2.2.20** - Smart map scale unit switching
- **v2.2.21** - Map mode persistence fix
- **v2.2.22** - Blueprint mode snapping (current)

## Files Changed
1. `/src/components/DimensionOverlay.tsx` - Added blueprint snapping to `snapCursorToAlignment()` function
