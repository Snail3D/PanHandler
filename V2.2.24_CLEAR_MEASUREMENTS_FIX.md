# v2.2.24 - Clear Measurements on New Photo

## Release Date
October 17, 2025

## Summary
Fixed measurements persisting when taking a new photo after returning to the app.

---

## üêõ Bug Report

### User Description
> "I came back in to Maps after adding a new photo, and all my old points were still there. That shouldn't happen."

### The Problem
When taking a new photo, old measurements from the previous photo were still visible. This happened because:

1. In v2.2.23, I removed measurement clearing from `setImageUri()` to fix performance
2. Measurements are persisted in AsyncStorage
3. When `setImageUri(newPhotoUri)` was called, measurements weren't cleared
4. Old measurements remained visible on new photo

### Why It Happened
The fix in v2.2.23 optimized `setImageUri(null)` (going to camera) but didn't handle `setImageUri(newPhotoUri)` (new photo captured).

**Old code (v2.2.23):**
```typescript
setImageUri: (uri) => set({
  currentImageUri: uri,
  // Only cleared calibration when uri = null
  ...(uri === null ? { coinCircle: null, calibration: null } : {})
  // Measurements NOT cleared when uri = new photo!
})
```

---

## ‚úÖ The Fix

### New Logic
```typescript
setImageUri: (uri) => {
  // NEW PHOTO: Clear everything
  if (uri !== null) {
    return {
      currentImageUri: uri,
      measurements: [],
      completedMeasurements: [],
      currentPoints: [],
      tempPoints: [],
      coinCircle: null,
      calibration: null,
      savedZoomState: null,
      imageOrientation: null,
    };
  }
  
  // GOING TO CAMERA: Just clear calibration
  return {
    currentImageUri: null,
    coinCircle: null,
    calibration: null,
    imageOrientation: null,
    savedZoomState: null,
  };
}
```

### Two Different Paths

**Path 1: New Photo Captured** (uri !== null)
- Clear ALL measurements
- Clear calibration
- Clear zoom state
- Start fresh ‚úÖ

**Path 2: Return to Camera** (uri === null)
- Only clear calibration
- Keep measurements empty (already cleared)
- Faster transition ‚úÖ

---

## How It Works Now

### Scenario 1: Take New Photo
1. Capture photo ‚Üí `setImageUri('file://...`)`
2. **Trigger:** uri !== null
3. **Action:** Clear all measurements + calibration
4. **Result:** Clean slate for new photo ‚úÖ

### Scenario 2: Go Back to Camera
1. Tap "New Photo" ‚Üí `setImageUri(null)`
2. **Trigger:** uri === null
3. **Action:** Only clear calibration (measurements already empty)
4. **Result:** Fast transition to camera ‚úÖ

### Scenario 3: Return to App
1. App closed with measurements
2. App reopened ‚Üí AsyncStorage restores imageUri + measurements
3. User taps "New Photo" ‚Üí `setImageUri(newUri)`
4. **Trigger:** uri !== null
5. **Action:** Clear all old measurements
6. **Result:** Fresh start on new photo ‚úÖ

---

## User Experience

### Before Fix
‚ùå Take photo #1, make measurements  
‚ùå Take photo #2  
‚ùå Old measurements from photo #1 still visible!  
‚ùå Confusing and wrong  

### After Fix
‚úÖ Take photo #1, make measurements  
‚úÖ Take photo #2  
‚úÖ Photo #2 is clean - no old measurements  
‚úÖ Clear separation between photos  

---

## Technical Details

### File Modified
`/src/state/measurementStore.ts` - `setImageUri()` function (lines 140-165)

### Key Changes
1. **Added conditional logic** - Check if uri is null or a new photo
2. **New photo path** - Clear everything when uri !== null
3. **Camera path** - Only clear calibration when uri === null
4. **Preserved performance** - No AsyncStorage blocking (single state update)

### Why This Doesn't Hurt Performance
- Still only ONE state update (not multiple)
- Clearing happens synchronously in a single `set()` call
- AsyncStorage write happens once, not cascaded
- Fast and clean!

---

## Edge Cases Handled

### Case 1: Quick Photo Succession
- Take photo ‚Üí Immediately take another photo
- ‚úÖ Second photo is clean

### Case 2: App Restoration
- Take photo with measurements ‚Üí Close app ‚Üí Open app ‚Üí Take new photo
- ‚úÖ New photo is clean (old measurements cleared)

### Case 3: Recalibrate
- Take photo ‚Üí Recalibrate button
- ‚úÖ Keeps same image, only clears measurements/calibration
- (Handled separately in MeasurementScreen)

---

## Testing Checklist

- [x] Take photo #1 ‚Üí Add measurements ‚Üí Take photo #2 ‚Üí Photo #2 is clean ‚úì
- [x] Take photo ‚Üí Close app ‚Üí Open app ‚Üí Measurements restored ‚úì
- [x] Restored measurements ‚Üí Take new photo ‚Üí New photo is clean ‚úì
- [x] Take photo ‚Üí Tap "New Photo" ‚Üí Camera appears fast ‚úì
- [x] No performance regression ‚úì

---

## Version History
- **v2.2.22** - Blueprint mode snapping
- **v2.2.23** - Performance fixes + polygon detection restored
- **v2.2.24** - Clear measurements on new photo (current)

## Files Changed
1. `/src/state/measurementStore.ts` - Fixed `setImageUri()` to clear measurements for new photos
