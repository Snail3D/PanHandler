# v2.2.0 - Blueprint Scale Calibration

**Date**: October 17, 2025  
**Status**: ✅ Complete

## Feature Overview

Added **Blueprint Scale** calibration mode, allowing users to calibrate by placing two points on a known distance in their blueprint, drawing, or document.

## Problem Solved

Previously, calibration was limited to:
- **Coin calibration**: Requires a physical coin in the photo
- **Verbal scale**: Requires knowing the map's printed scale (e.g., "1cm = 1km")

**New Solution**: Blueprint Scale lets users:
1. Place 2 points on any known distance in their image
2. Enter the real-world distance
3. App calculates calibration automatically

Perfect for:
- Architectural blueprints
- Engineering drawings
- Floor plans
- Technical diagrams
- Any document with a scale bar or known dimension

## Implementation

### 1. Updated VerbalScaleModal (`VerbalScaleModal.tsx`)

**Added Mode Selector:**
- Side-by-side cards for "Verbal Scale" vs "Blueprint Scale"
- Verbal Scale: Traditional "1cm = 1km" input
- Blueprint Scale: "Place 2 points" workflow

**UI Changes:**
- Lines 10-107: Added mode selector with beautiful cards
- Lines 161-231: Wrapped verbal scale content in conditional
- Lines 233-281: Added blueprint mode card with "START PLACEMENT" button
- Line 15: Added `onBlueprintMode` callback prop

### 2. Created BlueprintPlacementModal (`BlueprintPlacementModal.tsx`)

**New Component Features:**
- Instructional overlay during point placement
- Progress indicator showing "Tap to place first point" → "Tap to place second point"
- Visual progress with checkmarks
- Glassmorphic design matching app aesthetic

**Key Elements:**
- Lines 93-119: Progress circles with checkmarks
- Lines 121-127: Connecting line between progress indicators
- Lines 73-91: Dynamic instructions based on points placed

### 3. Created BlueprintDistanceModal (`BlueprintDistanceModal.tsx`)

**Distance Input Interface:**
- Numeric input for distance value
- Unit selector: mm, cm, in, m, ft
- Live preview of entered distance
- "LOCK IN" button with GoldenEye haptics

**Features:**
- Lines 95-107: Large numeric text input
- Lines 110-140: 5-unit toggle selector
- Lines 143-156: Live preview badge
- Lines 159-184: LOCK IN button

### 4. Updated DimensionOverlay (`DimensionOverlay.tsx`)

**State Management:**
- Line 341: `showBlueprintPlacementModal` state
- Line 342: `blueprintPoints` array (stores 2 points)
- Line 343: `showBlueprintDistanceModal` state

**Point Placement Logic (Lines 6693-6719):**
```typescript
{showBlueprintPlacementModal && blueprintPoints.length < 2 && (
  <View onResponderGrant={(event) => {
    const { pageX, pageY } = event.nativeEvent;
    const newPoint = { x: pageX, y: pageY };
    setBlueprintPoints([...blueprintPoints, newPoint]);
    
    if (updatedPoints.length === 2) {
      // Show distance input modal
      setShowBlueprintDistanceModal(true);
    }
  }} />
)}
```

**Visual Feedback (Lines 6722-6767):**
- Dashed line connecting the two points
- Circles with glow at each point
- Uses session color for consistency
- White center dots for precision

**Calibration Calculation (Lines 6771-6808):**
```typescript
const dx = blueprintPoints[1].x - blueprintPoints[0].x;
const dy = blueprintPoints[1].y - blueprintPoints[0].y;
const pixelDistance = Math.sqrt(dx * dx + dy * dy);
const pixelsPerUnit = pixelDistance / distance;

const newCalibration = {
  pixelsPerUnit,
  unit,
  referenceDistance: distance,
  calibrationType: 'blueprint',
};
```

### 5. Updated Store (`measurementStore.ts`)

**Extended Calibration Support:**
- Line 53: Added 'm' and 'ft' to unit types
- Line 55: Added 'blueprint' to calibrationType

**Before:**
```typescript
unit: 'mm' | 'cm' | 'in';
calibrationType?: 'coin' | 'verbal';
```

**After:**
```typescript
unit: 'mm' | 'cm' | 'in' | 'm' | 'ft';
calibrationType?: 'coin' | 'verbal' | 'blueprint';
```

## User Flow

### Blueprint Scale Workflow:

1. **Map Scale Modal Opens**
   - User sees two options: "Verbal Scale" and "Blueprint Scale"
   
2. **User Selects Blueprint Scale**
   - Taps "Blueprint Scale" card
   - Taps "START PLACEMENT" button
   
3. **Point Placement Phase**
   - Modal shows: "Tap to place first point"
   - User taps first location
   - Haptic feedback + visual circle appears
   - Modal updates: "Tap to place second point"
   - User taps second location
   - Dashed line connects the points
   
4. **Distance Entry Phase**
   - Distance input modal appears
   - User enters distance value (numeric keyboard)
   - User selects unit (mm, cm, in, m, ft)
   - Live preview shows: "10 cm" (example)
   - User taps "LOCK IN"
   
5. **Calibration Complete**
   - App calculates pixelsPerUnit
   - Stores calibration in store
   - GoldenEye success haptics
   - Ready to measure!

## Technical Details

### Calculation Method

**Pixel Distance:**
```javascript
const dx = point2.x - point1.x;
const dy = point2.y - point1.y;
const pixelDistance = Math.sqrt(dx * dx + dy * dy);
```

**Calibration:**
```javascript
pixelsPerUnit = pixelDistance / realDistance
```

**Example:**
- Points placed 500 pixels apart
- User enters "10 cm"
- Result: 50 pixels per cm
- All measurements use this ratio

### Supported Units

| Unit | Name | Use Case |
|------|------|----------|
| mm | Millimeters | Precision engineering |
| cm | Centimeters | General blueprints |
| in | Inches | US architectural drawings |
| m | Meters | Large-scale plans |
| ft | Feet | US construction documents |

### Visual Design

**Session Color Integration:**
- Blueprint points use session color
- Matches shutter button color
- Consistent with camera/calibration UI
- Falls back to green if no session color

**Point Visualization:**
- Outer glow (opacity 0.2, radius 20)
- Main circle (radius 12, white stroke)
- Center dot (radius 3, white fill)
- Dashed connecting line (8,4 pattern)

## Files Created

1. `src/components/BlueprintPlacementModal.tsx` (164 lines)
   - Instructional overlay during placement
   
2. `src/components/BlueprintDistanceModal.tsx` (232 lines)
   - Distance input interface

## Files Modified

1. `src/components/VerbalScaleModal.tsx`
   - Lines 10-15: Added mode type and onBlueprintMode prop
   - Lines 22, 149-281: Added mode selector and blueprint card

2. `src/components/DimensionOverlay.tsx`
   - Line 21: Imported BlueprintPlacementModal
   - Line 22: Imported BlueprintDistanceModal
   - Lines 341-343: Added blueprint state
   - Lines 6668-6671: Added onBlueprintMode handler
   - Lines 6683-6808: Added point placement, visualization, and calculation logic

3. `src/state/measurementStore.ts`
   - Line 53: Extended unit types to include 'm' and 'ft'
   - Line 55: Added 'blueprint' to calibrationType

4. `src/screens/MeasurementScreen.tsx`
   - Lines 2127-2131: Added onBlueprintMode handler

## Comparison: Calibration Methods

| Method | Best For | Pros | Cons |
|--------|----------|------|------|
| **Coin** | Photos with reference objects | Fast, no knowledge needed | Requires coin in photo |
| **Verbal Scale** | Maps with printed scale | Quick if you know the scale | Must know exact scale ratio |
| **Blueprint** ⭐ NEW | Drawings with dimensions | Works on any known distance | Requires one known measurement |

## Testing Checklist

- [x] Mode selector displays correctly
- [x] Blueprint button opens placement mode
- [x] First tap places point with visual feedback
- [x] Second tap places point and connects line
- [x] Distance modal opens after 2 points
- [x] Numeric input works properly
- [x] Unit selector changes units
- [x] Live preview updates correctly
- [x] LOCK IN calculates calibration
- [x] Measurements work with blueprint calibration
- [ ] User testing on real blueprints
- [ ] Verify accuracy with known dimensions

## Known Limitations

1. Points must be placed on a straight line distance
2. Accuracy depends on image quality and point placement precision
3. Works best with high-resolution images
4. User must know at least one dimension in the image

## Future Enhancements

- [ ] Allow editing/moving placed points before locking in
- [ ] Show pixel distance and calculated ratio before confirming
- [ ] Support angled measurements (not just horizontal/vertical)
- [ ] Add "common scales" presets (1:50, 1:100, etc.)
- [ ] Visual guides for better point placement accuracy

---

**Previous Version**: v2.1.9 (Session Color Collapsed Tab)  
**Impact**: Major feature addition - new calibration method  
**User Benefit**: Can now measure blueprints and drawings without coins or knowing the scale
